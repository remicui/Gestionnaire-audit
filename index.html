<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Audit BECHAMEIL - Expert</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --bleu-nuit-soft: #1a3a5a;    
            --bleu-accent: #2c527a;       
            --bleu-fond: #f0f5fa;         
            --jaune-bechameil: #fbc02d;    
            --blanc: #ffffff;
            --gris-clair: #e0e0e0;
        }

        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background-color: #f4f7f9; color: var(--bleu-nuit-soft); line-height: 1.3; }
        
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bleu-nuit-soft);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; color: white;
        }
        .lock-card { background: white; padding: 30px; border-radius: 12px; text-align: center; color: var(--bleu-nuit-soft); box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 300px; }
        .lock-input { width: 100%; padding: 15px; margin: 15px 0; border: 2px solid var(--bleu-fond); border-radius: 8px; font-size: 1.2em; text-align: center; box-sizing: border-box; }
        
        #app-shell { max-width: 1050px; margin: 0 auto; padding: 10px; display: none; }
        
        .nav-bar { background: var(--bleu-nuit-soft); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-radius: 0 0 8px 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .view { display: none; }
        .view.active { display: block; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn-main { background: var(--bleu-nuit-soft); color: var(--jaune-bechameil); border: none; padding: 18px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px; font-size: 1.1em; text-transform: uppercase; }
        
        .home-hero { 
            background: linear-gradient(135deg, var(--bleu-nuit-soft) 0%, var(--bleu-accent) 100%);
            padding: 50px 20px; border-radius: 12px; text-align: center; margin-bottom: 30px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .logo-container { background: white; display: inline-block; padding: 25px 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 25px; }
        .home-hero img { max-height: 130px; width: auto; display: block; }
        .home-hero h2 { background: transparent; color: var(--jaune-bechameil); justify-content: center; margin-top: 10px; font-size: 1.6em; letter-spacing: 1px; text-transform: uppercase; }

        .search-container { position: relative; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 12px 15px 12px 40px; border: 2px solid var(--bleu-fond); border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--bleu-accent); }

        .report-item { border-bottom: 1px solid var(--gris-clair); padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .report-info-main { font-size: 1.25em; font-weight: bold; color: #000; display: block; }

        .page { background: var(--blanc); padding: 40px; box-shadow: 0 5px 15px rgba(26, 58, 90, 0.1); border-radius: 8px; border-top: 10px solid var(--jaune-bechameil); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--bleu-nuit-soft); padding-bottom: 20px; }
        .logo-img { max-height: 90px; }
        .header-title { text-align: right; }
        .header-title h1 { margin: 0; color: var(--bleu-nuit-soft); font-size: 1.8em; text-transform: uppercase; }
        h2 { background: var(--bleu-nuit-soft); color: var(--jaune-bechameil); padding: 10px 15px; font-size: 1.1em; margin-top: 25px; border-radius: 4px; text-transform: uppercase; display: flex; align-items: center; }
        h2::before { content: "‚óÜ"; margin-right: 12px; }
        
        label { font-weight: bold; display: inline-block; width: 230px; vertical-align: top; font-size: 0.95em; }
        input, select, textarea { padding: 7px; border: 1px solid var(--bleu-accent); border-radius: 4px; font-size: 16px; font-family: inherit; }
        
        .io-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        .io-table th, .io-table td { border: 1px solid var(--bleu-accent); padding: 5px; text-align: left; }
        .io-table th { background: var(--bleu-fond); }
        
        .axe-container { border: 1px solid var(--bleu-accent); padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #fdfdfe; border-left: 8px solid var(--jaune-bechameil); position: relative; }
        .axe-title { font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid var(--bleu-fond); padding-bottom: 8px; font-size: 1.1em; color: var(--bleu-nuit-soft); }
        .grid-axe { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-axe div { display: flex; align-items: center; font-size: 0.85em; }
        .grid-axe label { width: 130px; flex-shrink: 0; color: var(--bleu-accent); font-weight: bold; }
        
        .photo-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 15px; }
        .photo-item { border: 2px dashed var(--bleu-accent); min-height: 150px; display: flex; align-items: center; justify-content: center; background: #fafafa; border-radius: 5px; cursor: pointer; }
        .photo-item img { width: 100%; max-height: 500px; object-fit: contain; }
        .photo-wrapper { position: relative; margin-bottom: 20px; }
        
        .btn-add { background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-remove { background: #c0393b; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; }
        .tech-tooltip { position: absolute; background: #222; color: #fff; padding: 10px 14px; border-radius: 5px; font-size: 12.5px; z-index: 3000; max-width: 280px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); pointer-events: none; display: none; border-left: 5px solid var(--jaune-bechameil); line-height: 1.4; }
        
        @media print { 
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body { background: white; }
            .no-print, #saveMsg, .btn-remove, .btn-add { display: none !important; } 
            .page { box-shadow: none !important; border-radius: 0 !important; padding: 0 !important; margin: 0 !important; border-top: 10px solid var(--jaune-bechameil) !important; } 
            .axe-container { page-break-inside: avoid; break-inside: avoid; border: 1px solid var(--bleu-accent) !important; border-left: 8px solid var(--jaune-bechameil) !important; background: #fdfdfe !important; }
            .photo-wrapper { page-break-inside: avoid; break-inside: avoid; }
            h2 { background: var(--bleu-nuit-soft) !important; color: var(--jaune-bechameil) !important; page-break-after: avoid; padding: 10px 15px !important; border-radius: 4px !important; }
            .io-table th { background: var(--bleu-fond) !important; }
            input, select, textarea { border: 1px solid #eee !important; background: transparent !important; }
            .cod-hidden, .io-hidden, .log-hidden { display: none !important; }
        }

        .save-indicator { position: fixed; bottom: 20px; right: 20px; background: #27ae60; color: white; padding: 5px 15px; border-radius: 20px; display: none; z-index: 2000; }
        .cod-hidden, .io-hidden, .log-hidden { display: none !important; }
    </style>
</head>
<body onload="checkLock()">

<div id="lock-screen">
    <img src="Logo_.png" alt="BECHAMEIL" style="max-height: 80px; margin-bottom: 20px; filter: brightness(0) invert(1);">
    <div class="lock-card">
        <h3>Acc√®s S√©curis√©</h3>
        <p>Veuillez entrer le code d'acc√®s</p>
        <input type="password" id="passCode" class="lock-input" placeholder="****">
        <button class="btn-main" onclick="verifyCode()" style="margin-bottom:0;">Valider</button>
    </div>
</div>

<div id="saveMsg" class="save-indicator">Enregistr√© ‚úì</div>
<div id="tooltip" class="tech-tooltip"></div>

<div id="app-shell">
    <div class="nav-bar no-print">
        <h1 style="margin:0; font-size:1.2em;">üõ† BECHAMEIL - Manager Audit</h1>
        <div style="display: flex; gap: 8px;">
            <button onclick="forceUpdate()" style="background:rgba(255,255,255,0.15); border:1px solid white; color:white; padding:8px 12px; border-radius:4px; cursor:pointer; font-size:0.8em;">üîÑ MAJ</button>
            <button onclick="showView('home')" style="background:rgba(255,255,255,0.2); border:1px solid white; color:white; padding:8px 12px; border-radius:4px; cursor:pointer; font-weight:bold;">üè† ACCUEIL</button>
            <button onclick="logout()" style="background:rgba(255,0,0,0.2); border:1px solid white; color:white; padding:8px 12px; border-radius:4px; cursor:pointer;">üîí QUITTER</button>
        </div>
    </div>

    <div id="home" class="view active">
        <div class="home-hero">
            <div class="logo-container"><img src="Logo_.png" alt="BECHAMEIL"></div>
            <h2>Plateforme d'Audit Technique</h2>
            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.95em; font-weight: bold;">Expertise ‚Ä¢ R√©trofit ‚Ä¢ Automatisme</p>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">CR√âER UNE NOUVELLE INTERVENTION</h3>
            <select id="reportType" style="width:100%; padding:15px; margin-bottom:15px; font-size:1.1em; font-weight:bold;">
                <option value="AUDIT R√âTROFIT AUTOMATISME">Audit R√©trofit Automatisme</option>
                <option value="AUDIT R√âTROFIT √âLECTRIQUE">Audit R√©trofit √âlectrique</option>
            </select>
            <button class="btn-main" onclick="createNewReport()">‚ûï COMMENCER L'AUDIT</button>
        </div>
        
        <div class="card">
            <h3>HISTORIQUE DES RAPPORTS</h3>
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="auditSearch" class="search-input" placeholder="Rechercher par machine ou client..." oninput="filterAudits()">
            </div>
            <div id="historyList"></div>
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importAudit(this)">
                <button class="btn-main" style="background:#27ae60; font-size: 0.9em; padding: 12px;" onclick="document.getElementById('importFile').click()">üì§ IMPORTER UN FICHIER JSON</button>
            </div>
        </div>
    </div>

    <div id="form-view" class="view">
        <div class="page">
            <form id="auditForm" oninput="saveCurrentReport()">
                <input type="hidden" id="currentReportId">
                <div class="header">
                    <img src="Logo_.png" alt="BECHAMEIL" class="logo-img">
                    <div class="header-title">
                        <h1 id="displayReportType">AUDIT TECHNIQUE</h1>
                        <p style="margin-top:5px; color:var(--bleu-accent);">R√©trofit Automatisme & M√©canique</p>
                    </div>
                </div>

                <div class="section">
                    <label>Date de l'Audit :</label> <input type="date" id="auditDate" style="width:200px"><br><br>
                    <label>Client / Site :</label> <input type="text" id="clientName" style="width:60%"><br><br>
                    <label>Adresse :</label> <input type="text" id="clientAddress" style="width:60%" placeholder="N¬∞, Rue, CP, Ville"><br><br>
                    <label>Machine / Rep√®re :</label> <input type="text" id="machineName" style="width:60%"><br><br>
                    <label>Charg√© d'Affaires :</label> <input type="text" id="expertName" style="width:60%" value="Expert BECHAMEIL">
                </div>

                <h2>1. CONTR√îLE & COMMUNICATION (API)</h2>
                <div class="section">
                    <label>Marque CPU :</label> <select id="cpuBrand" onchange="updateCpuModels();" class="has-tech-info" style="width:50%"></select><br><br>
                    <label>Mod√®le CPU :</label> <select id="cpuModel" class="has-tech-info" style="width:50%"><option value="">-- Choisir marque --</option></select><br><br>
                    <label>R√©f√©rence :</label> <input type="text" id="cpuRef" style="width:50%"><br><br>
                    <label>Bus de terrain :</label> 
                    <input type="checkbox" id="bus_profibus"> Profibus | <input type="checkbox" id="bus_can"> CANopen | <input type="checkbox" id="bus_eth"> Eth/IP | <input type="checkbox" id="bus_asi"> AS-i <br><br>
                    <label>E/S D√©port√©es :</label> 
                    <input type="checkbox" id="io_dep_non" onclick="document.getElementById('io_dep_oui').checked=false; toggleIoFields(document.getElementById('io_dep_oui'))"> Non | 
                    <input type="checkbox" id="io_dep_oui" onclick="document.getElementById('io_dep_non').checked=false; toggleIoFields(this)"> Oui 
                    <span id="io_nb_container" class="io-hidden">(Nb √Ælots : <input type="number" id="io_nb" style="width:45px">)</span><br><br>
                    <table class="io-table" id="ioTable">
                        <thead><tr><th>Marque / Gamme</th><th>Type (DI/DO/AI...)</th><th>R√©f. Carte</th><th>Nb Voies</th><th class="no-print">Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" class="btn-add no-print" onclick="addIORow();" style="margin-top:10px;">‚ûï Ajouter une ligne E/S</button>
                </div>

                <h2>2. MOTORISATION & VARIATION</h2>
                <div id="axes-list"></div>
                <div class="no-print" style="text-align:center;"><button type="button" class="btn-add" style="padding:15px 30px;" onclick="addAxe();">‚ûï AJOUTER UN AXE MOTEUR</button></div>

                <h2>3. INTERFACE HOMME-MACHINE (IHM)</h2>
                <div class="section">
                    <label>Mod√®le actuel :</label> <input type="text" id="ihmModel" style="width:40%"> | &nbsp; <label style="width:auto">D√©coupe :</label> <input type="text" id="ihmCut" style="width:100px"> mm<br><br>
                    <label>Communication :</label> <input type="checkbox" id="ihm_ser"> S√©rie | <input type="checkbox" id="ihm_eth"> Ethernet | <input type="checkbox" id="ihm_mpi"> MPI/DP<br><br>
                    <label>Boutonnerie :</label> 
                    <input type="checkbox" id="btn_garder"> Garder | <input type="checkbox" id="btn_supp"> Suppr. | <input type="checkbox" id="btn_reca"> Rec√¢bler | <input type="checkbox" id="btn_neuf"> Remplacer par du neuf
                </div>

                <h2>4. S√âCURIT√â MACHINE (SAFETY)</h2>
                <div class="section">
                    <label>Gestion :</label> <input type="checkbox" id="saf_relais"> Relais | <input type="checkbox" id="saf_api"> API Safety | <input type="checkbox" id="saf_rien"> Rien<br><br>
                    <label>Dispositifs :</label> <input type="checkbox" id="saf_au"> AU | <input type="checkbox" id="saf_bar"> Barri√®res | <input type="checkbox" id="saf_sca"> Scanners | <input type="checkbox" id="saf_gac"> G√¢ches<br><br>
                    <label>Conformit√© :</label> <input type="checkbox" id="saf_ok"> OK | <input type="checkbox" id="saf_ko"> √Ä METTRE √Ä NIVEAU
                </div>

                <h2>5. ENVIRONNEMENT & √âLECTRICIT√â</h2>
                <div class="section">
                    <label>Place Armoire :</label> <input type="checkbox" id="env_pl_ok"> OK | <input type="checkbox" id="env_pl_ko"> Trop petite | <input type="checkbox" id="env_pl_ch"> √Ä changer<br><br>
                    <label>C√¢blage :</label> <input type="checkbox" id="env_cab_ok"> Sain | <input type="checkbox" id="env_cab_ko"> D√©grad√© | <input type="checkbox" id="env_cab_nr"> Non rep√©r√©<br><br>
                    <label>Alim 24V :</label> <input type="checkbox" id="env_alim_ok"> Garder | <input type="checkbox" id="env_alim_ko"> Remplacer par BECHAMEIL<br><br>
                    <label>Sch√©mas :</label> <input type="checkbox" id="env_sch_ok"> OK | <input type="checkbox" id="env_sch_ko"> Obsol√®tes | <input type="checkbox" id="env_sch_no"> Inexistants
                </div>

                <h2>6. LOGISTIQUE BECHAMEIL</h2>
                <div class="section">
                    <label>Lieu :</label> <input type="radio" name="lieu" id="lieuSite"> Site Client | <input type="radio" name="lieu" id="lieuAtelier"> Atelier BECHAMEIL<br><br>
                    <label>√âlectriciens :</label> <input type="checkbox" id="log_elec_oui" onclick="toggleLogFields(this, 'log_elec_data')"> Oui &nbsp;<span id="log_elec_data" class="log-hidden">(Nb pers : <input type="number" id="nbElec" style="width:45px"> | Nombre d'heures : <input type="text" id="hElec" style="width:70px">)</span><br><br>
                    <label>M√©caniciens :</label> <input type="checkbox" id="log_meca_oui" onclick="toggleLogFields(this, 'log_meca_data')"> Oui &nbsp;<span id="log_meca_data" class="log-hidden">(Nb pers : <input type="number" id="nbMeca" style="width:45px"> | Nombre d'heures : <input type="text" id="hMeca" style="width:70px">)</span><br><br>
                    <label>Arr√™t machine :</label> <input type="text" id="dureeArret" style="width:250px"><br><br>
                    <label>Levage :</label> <input type="checkbox" id="log_lev_non"> Non | <input type="checkbox" id="log_lev_c"> Pr√™t client | <input type="checkbox" id="log_lev_b"> √Ä pr√©voir
                </div>

                <h2>7. PHOTOS DU CONSTAT</h2>
                <div class="photo-grid" id="photoGrid"></div>
                <div class="no-print" style="text-align:center; margin-top:15px;"><button type="button" class="btn-add" onclick="addNewPhoto();">‚ûï AJOUTER UNE PHOTO</button></div>

                <h2>8. OBSERVATIONS ET NOTES G√âN√âRALES</h2>
                <textarea id="notesGen" rows="6" style="width: 100%; box-sizing: border-box;"></textarea>

                <div class="btn-container no-print" style="display:flex; gap:10px; margin-top:40px;">
                    <button type="button" style="background:#95a5a6; color:white; border:none; padding:20px; border-radius:5px; flex:1; cursor:pointer; font-weight:bold;" onclick="showView('home')">RETOUR ACCUEIL</button>
                    <button type="button" style="background:#2c527a; color:white; border:none; padding:20px; border-radius:5px; flex:1; cursor:pointer; font-weight:bold;" onclick="exportAudit()">üíæ EXPORTER JSON</button>
                    <button type="button" class="btn-main" style="flex:2; padding:20px;" onclick="window.print()">G√âN√âRER LE RAPPORT PDF</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const VALID_CODE = "AuditBechameil58!";
    let photoCounter = 0;

    const dbTechInfo = { 
        "Siemens": "Leader mondial. Gammes ET200S, ET200SP, ET200MP...", 
        "Schneider / T√©l√©m√©ca": "Standard fran√ßais. Gammes Advantys STB, OTB, TM3...", 
        "Rockwell / AB": "Haut de gamme. Gammes Point I/O, Flex I/O...", 
        "VIPA (Yaskawa)": "Totalement compatible Siemens S7. Gamme SLIO...", 
        "Wago": "Syst√®me modulaire 750/753 tr√®s r√©pandu..."
    };
    
    const dbIOBrands = ["Siemens", "Schneider / T√©l√©m√©ca", "Wago", "Beckhoff", "Rockwell / AB", "Autre"];
    const dbModelesVar = { "SEW Eurodrive": ["Movidrive MDX60/61B", "Movitrac MC07B", "Movitrac LTE-B", "Movimot"], "Schneider": ["Altivar 320 / 630 / 930", "Altivar 71 / 61"], "Siemens": ["Sinamics G120", "Micromaster 440"], "Autre": ["Mod√®le sp√©cifique"] };
    const dbModelesCpu = { "Siemens": ["S7-1500", "S7-1200", "S7-300", "S7-400", "S5-95U/115U/135U"], "Schneider / T√©l√©m√©ca": ["M580", "M340", "Premium (TSX57)", "Micro (TSX37)"], "Autre": ["Mod√®le sp√©cifique"] };

    function checkLock() { if (localStorage.getItem('bechameil_auth_persistent') === 'true') unlockApp(); }
    function verifyCode() { if (document.getElementById('passCode').value === VALID_CODE) { localStorage.setItem('bechameil_auth_persistent', 'true'); unlockApp(); } else alert("Code erron√©."); }
    function unlockApp() { document.getElementById('lock-screen').style.display = 'none'; document.getElementById('app-shell').style.display = 'block'; initApp(); }
    function logout() { localStorage.removeItem('bechameil_auth_persistent'); window.location.reload(); }

    function forceUpdate() {
        if(confirm("V√©rifier les mises √† jour sur GitHub ? (La page va se recharger)")) {
            // Ajout d'un param√®tre al√©atoire pour forcer le t√©l√©chargement du nouveau fichier
            window.location.href = window.location.pathname + '?v=' + Date.now();
        }
    }

    function initApp() { cleanHistory(); populateCpuBrands(); updateHistoryList(); initTooltips(); }
    function filterAudits() { const query = document.getElementById('auditSearch').value.toLowerCase(); document.querySelectorAll('.report-item').forEach(item => { item.style.display = item.innerText.toLowerCase().includes(query) ? 'flex' : 'none'; }); }
    function cleanHistory() { for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key && key.startsWith('audit_')) { const data = JSON.parse(localStorage.getItem(key)); if (!data.machine || data.machine === "Machine non sp√©cifi√©e") localStorage.removeItem(key); } } }
    
    function initTooltips() { 
        const tooltip = document.getElementById('tooltip'); 
        document.addEventListener('mouseover', (e) => { 
            if (e.target.classList.contains('has-tech-info') || e.target.tagName === 'SELECT') { 
                const val = e.target.value; 
                if (val && dbTechInfo[val]) { tooltip.innerHTML = `<strong>${val}</strong><br>${dbTechInfo[val]}`; tooltip.style.display = 'block'; } 
            } 
        }); 
        document.addEventListener('mousemove', (e) => { if (tooltip.style.display === 'block') { tooltip.style.left = (e.pageX + 15) + 'px'; tooltip.style.top = (e.pageY + 15) + 'px'; } }); 
        document.addEventListener('mouseout', () => { tooltip.style.display = 'none'; }); 
    }

    function showView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id === 'home') updateHistoryList(); }

    function updateHistoryList() {
        const container = document.getElementById('historyList'); container.innerHTML = '';
        const audits = [];
        for (let i = 0; i < localStorage.length; i++) { if (localStorage.key(i).startsWith('audit_')) audits.push(JSON.parse(localStorage.getItem(localStorage.key(i)))); }
        audits.sort((a,b) => b.timestamp - a.timestamp).forEach(a => {
            const d = document.createElement('div');
            d.className = 'report-item';
            d.innerHTML = `<div style="flex:1;"><span class="report-info-main">${a.machine}</span><span style="color:#2c527a; font-weight:bold;">üè¢ ${a.client}</span></div>
            <div style="display:flex; gap:8px;">
                <button class="btn-add" style="background:var(--bleu-accent); padding:8px 12px; font-size:0.8em;" onclick="loadReport('${a.id}')">üìÇ OUVRIR</button>
                <button class="btn-add" style="background:#2c527a; padding:8px 12px; font-size:0.8em;" onclick="exportAuditDirect('${a.id}')">üíæ EXPORT</button>
                <button class="btn-remove" onclick="if(confirm('Supprimer ?')){localStorage.removeItem('${a.id}');updateHistoryList();}">‚ùå</button>
            </div>`;
            container.appendChild(d);
        });
    }

    function addAxe() {
        const list = document.getElementById('axes-list');
        const idx = list.children.length;
        const div = document.createElement('div');
        div.className = 'axe-container';
        div.innerHTML = `<button type="button" class="btn-remove no-print" onclick="this.parentElement.remove(); saveCurrentReport();" style="position:absolute; top:15px; right:15px;">‚ùå</button>
            <div class="axe-title">AXE MOTEUR N¬∞${idx + 1} : <input type="text" id="axe_name_${idx}" placeholder="Nom de l'axe" style="width:300px"></div>
            <div class="grid-axe">
                <div><label>Marque Var. :</label> <select id="axe_brand_${idx}" onchange="updateModelVarList(this); saveCurrentReport();"><option value="">--</option>${Object.keys(dbModelesVar).map(b=>`<option value="${b}">${b}</option>`).join('')}</select></div>
                <div><label>Mod√®le Var. :</label> <select id="axe_model_${idx}"><option value="">--</option></select></div>
                <div><label>R√©f√©rence Var. :</label> <input type="text" id="axe_ref_var_${idx}" style="width:160px"></div>
                <div><label>Puissance :</label> <input type="text" id="axe_pwr_${idx}" placeholder="kW" style="width:80px"> &nbsp;kW</div>
                <div style="grid-column: span 2; border-top: 1px solid #ddd; margin-top: 5px; padding-top: 10px;"><strong>Donn√©es Moteur :</strong></div>
                <div><label>Type / R√©f. :</label> <input type="text" id="axe_mot_ref_${idx}" style="width:160px"></div>
                <div><label>Vitesse (tr/min) :</label> <input type="text" id="axe_mot_speed_${idx}" style="width:100px"></div>
                <div><label>Intensit√© (A) :</label> <input type="text" id="axe_mot_amp_${idx}" placeholder="In" style="width:100px"></div>
                <div><label>Tension (V) :</label> <input type="text" id="axe_mot_volt_${idx}" placeholder="400V" style="width:100px"></div>
                <div><label>Couplage :</label> <input type="text" id="axe_mot_coup_${idx}" placeholder="Œî/Y" style="width:100px"></div>
                <div><label>Cos œÜ :</label> <input type="text" id="axe_mot_cos_${idx}" style="width:100px"></div>
                <div style="grid-column: span 2; border-top: 1px solid #ddd; margin-top: 5px; padding-top: 10px;"><strong>M√©canique :</strong></div>
                <div><label>R√©ducteur :</label> <input type="text" id="axe_red_ref_${idx}" style="width:160px"></div>
                <div><label>Rapport (i) :</label> <input type="text" id="axe_red_ratio_${idx}" style="width:100px"></div>
                <div><label>Frein :</label> <input type="checkbox" id="axe_fr_non_${idx}"> Non | <input type="checkbox" id="axe_fr_oui_${idx}"> Oui</div>
                <div style="grid-column: span 2; border-top: 1px solid #ddd; margin-top: 5px; padding-top: 10px;"><strong>Codeur :</strong></div>
                <div><label>Pr√©sence :</label> <input type="checkbox" id="axe_cod_non_${idx}" onclick="document.getElementById('axe_cod_oui_${idx}').checked=false; toggleEncoderFields(document.getElementById('axe_cod_oui_${idx}'), ${idx})"> Non | <input type="checkbox" id="axe_cod_oui_${idx}" onclick="document.getElementById('axe_cod_non_${idx}').checked=false; toggleEncoderFields(this, ${idx})"> Oui</div>
                <div class="cod-row-${idx} cod-hidden" style="grid-column: span 2; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%;">
                    <div><label>Type Codeur :</label> <input type="text" id="axe_cod_type_${idx}" placeholder="Incr√©mental / SSI / SinCos" style="width:160px"></div>
                    <div><label>R√©f. Codeur :</label> <input type="text" id="axe_cod_ref_${idx}" style="width:160px"></div>
                    <div><label>R√©solution :</label> <input type="text" id="axe_cod_res_${idx}" placeholder="ex: 1024 ppr" style="width:160px"></div>
                    <div><label>Alim (V) :</label> <input type="text" id="axe_cod_volt_${idx}" placeholder="5V / 24V" style="width:100px"></div>
                </div>
            </div>`;
        list.appendChild(div);
    }

    function updateModelVarList(sel) {
        const brand = sel.value; const modelSel = document.getElementById(sel.id.replace('brand', 'model'));
        modelSel.innerHTML = '<option value="">--</option>';
        if(dbModelesVar[brand]) dbModelesVar[brand].forEach(m => modelSel.innerHTML += `<option value="${m}">${m}</option>`);
    }

    function toggleEncoderFields(cb, idx) { document.querySelectorAll('.cod-row-'+idx).forEach(el => el.classList.toggle('cod-hidden', !cb.checked)); }
    function toggleIoFields(cb) { document.getElementById('io_nb_container').classList.toggle('io-hidden', !cb.checked); }
    function toggleLogFields(cb, targetId) { document.getElementById(targetId).classList.toggle('log-hidden', !cb.checked); }

    function addNewPhoto(src = null) {
        photoCounter++;
        const grid = document.getElementById('photoGrid');
        const div = document.createElement('div');
        div.className = 'photo-wrapper';
        div.innerHTML = `<div class="photo-item" id="p_item_${photoCounter}" onclick="document.getElementById('img_${photoCounter}').click()">
            <span id="txt_${photoCounter}" style="${src ? 'display:none' : ''}">üì∏ Cliquez pour ajouter</span>
            <img id="prev_${photoCounter}" src="${src || ''}" style="${src ? 'display:block' : 'display:none'}">
            <input type="file" id="img_${photoCounter}" accept="image/*" style="display:none" onchange="previewImg(this, ${photoCounter})">
        </div><button type="button" class="btn-remove no-print" onclick="this.parentElement.remove(); saveCurrentReport();" style="position:absolute; top:10px; right:10px;">‚ùå</button>`;
        grid.appendChild(div);
    }

    function previewImg(input, id) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('prev_'+id).src = compressedData;
                    document.getElementById('prev_'+id).style.display = 'block';
                    document.getElementById('txt_'+id).style.display = 'none';
                    saveCurrentReport();
                };
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function addIORow() {
        const tbody = document.getElementById('ioTable').querySelector('tbody');
        const row = tbody.insertRow();
        row.innerHTML = `<td><select style="width:95%">${dbIOBrands.map(b=>`<option value="${b}">${b}</option>`).join('')}</select></td><td><input type="text" style="width:90%"></td><td><input type="text" style="width:90%"></td><td><input type="text" style="width:90%"></td><td class="no-print"><button type="button" class="btn-remove" onclick="this.parentElement.parentElement.remove(); saveCurrentReport();">‚ùå</button></td>`;
    }

    function saveCurrentReport() {
        const id = document.getElementById('currentReportId').value; if(!id) return;
        const photosData = []; 
        document.querySelectorAll('.photo-wrapper img').forEach(img => { if(img.src && img.src.startsWith('data:')) photosData.push(img.src); });
        const data = {
            id: id, type: document.getElementById('displayReportType').innerText, timestamp: Date.now(),
            client: document.getElementById('clientName').value || "Soci√©t√© Inconnue",
            machine: document.getElementById('machineName').value || "Machine non sp√©cifi√©e",
            inputs: Array.from(document.querySelectorAll('input:not([type="file"]), select, textarea')).map(i => ({ id: i.id, val: (i.type === 'checkbox' || i.type === 'radio') ? i.checked : i.value })),
            axeCount: document.querySelectorAll('.axe-container').length,
            ioCount: document.querySelector('#ioTable tbody').rows.length,
            photos: photosData
        };
        localStorage.setItem(id, JSON.stringify(data));
        showSaveIndicator();
    }

    function loadReport(id) {
        const data = JSON.parse(localStorage.getItem(id));
        document.getElementById('currentReportId').value = id;
        document.getElementById('displayReportType').innerText = data.type;
        document.getElementById('axes-list').innerHTML = ''; for(let i=0; i<data.axeCount; i++) addAxe();
        document.querySelector('#ioTable tbody').innerHTML = ''; for(let i=0; i<data.ioCount; i++) addIORow();
        document.getElementById('photoGrid').innerHTML = '';
        if(data.photos) data.photos.forEach(pSrc => addNewPhoto(pSrc));
        data.inputs.forEach(item => { const el = document.getElementById(item.id); if(el) { if(el.type === 'checkbox' || el.type === 'radio') el.checked = item.val; else el.value = item.val; } });
        showView('form-view');
    }

    function createNewReport() {
        const id = 'audit_' + Date.now();
        document.getElementById('auditForm').reset();
        document.getElementById('currentReportId').value = id;
        document.getElementById('displayReportType').innerText = document.getElementById('reportType').value;
        document.getElementById('axes-list').innerHTML = '';
        document.getElementById('ioTable').querySelector('tbody').innerHTML = '';
        document.getElementById('photoGrid').innerHTML = '';
        document.getElementById('auditDate').value = new Date().toISOString().split('T')[0];
        addIORow(); addAxe(); addNewPhoto(); showView('form-view');
    }

    function exportAudit() {
        const id = document.getElementById('currentReportId').value;
        if(!id) return;
        exportAuditDirect(id);
    }

    function exportAuditDirect(id) {
        const dataString = localStorage.getItem(id);
        const data = JSON.parse(dataString);
        const blob = new Blob([dataString], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Audit_${data.machine || 'SansNom'}.json`;
        a.click();
    }

    function importAudit(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = JSON.parse(e.target.result);
            localStorage.setItem(data.id, e.target.result);
            updateHistoryList();
            alert("Rapport import√© avec succ√®s !");
        };
        reader.readAsText(file);
    }

    function populateCpuBrands() { const sel = document.getElementById('cpuBrand'); sel.innerHTML = '<option value="">-- Choisir --</option>'; Object.keys(dbModelesCpu).forEach(b => sel.innerHTML += `<option value="${b}">${b}</option>`); }
    function updateCpuModels() { const brand = document.getElementById('cpuBrand').value; const sel = document.getElementById('cpuModel'); sel.innerHTML = '<option value="">-- Mod√®le --</option>'; if(dbModelesCpu[brand]) dbModelesCpu[brand].forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`); }
    function showSaveIndicator() { const s = document.getElementById('saveMsg'); s.style.display='block'; setTimeout(()=>s.style.display='none', 1000); }
</script>
</body>
</html>
